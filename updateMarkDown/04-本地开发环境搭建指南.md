# Metabase 本地开发环境搭建指南

## 项目概述

Metabase 是一个开源的商业智能和数据分析平台,由两个主要组件构成:
- **后端**: 使用 Clojure 编写,包含 REST API 和数据库查询处理逻辑
- **前端**: JavaScript 单页应用,提供 Web UI 界面

## 环境要求

### 必需软件

1. **Node.js**
   - 版本要求: >= 22
   - 用途: 前端构建和依赖管理

2. **Yarn**
   - 版本要求: ^1.12.3
   - 用途: JavaScript 包管理器

3. **Java**
   - 推荐版本: Java 11 或更高版本
   - 用途: 运行 Clojure 后端

4. **Clojure CLI**
   - 用途: Clojure 项目构建和依赖管理
   - 安装: https://clojure.org/guides/install_clojure

### 可选软件

5. **PostgreSQL** (推荐用于开发)
   - 用途: 应用数据库(默认使用 H2,但推荐使用 PostgreSQL)
   - 端口: 5432

6. **Docker** (可选)
   - 用途: 运行容器化的数据库和服务
   - 配置文件: `dev/docker-compose.yml`

## 快速启动步骤

### 方法一: 一键启动(推荐)

这是最简单的启动方式,会同时启动前端和后端:

```bash
# 在项目根目录执行
yarn dev
```

这个命令会:
- 启动后端服务器 (端口 3000)
- 启动前端热重载构建 (端口 8088)
- 构建 ClojureScript 代码
- 构建静态可视化组件

### 方法二: 分别启动前后端

如果你需要更细粒度的控制,可以在两个终端窗口中分别启动:

#### 终端 1: 启动前端

```bash
# 1. 安装 JavaScript 依赖
yarn install

# 2. 启动前端热重载开发服务器
yarn build-hot
```

前端开发服务器会在 `http://localhost:8088` 启动。

#### 终端 2: 启动后端

```bash
# 1. 构建数据库驱动(首次运行或驱动更新时需要)
./bin/build-drivers.sh

# 2. 启动后端服务器
clojure -M:run
```

后端服务器会在 `http://localhost:3000` 启动。

## Windows 系统特别说明

由于你使用的是 Windows 系统,需要注意以下几点:

### 1. 运行 Shell 脚本

Windows 上运行 `.sh` 脚本需要:
- **Git Bash** (推荐): 随 Git for Windows 安装
- **WSL (Windows Subsystem for Linux)**: 完整的 Linux 环境
- **Cygwin**: 另一个 Unix-like 环境

#### 使用 Git Bash 运行驱动构建:

```bash
# 在 Git Bash 中执行
./bin/build-drivers.sh
```

#### 或者直接使用 Clojure 命令:

```bash
# Windows CMD 或 PowerShell 中执行
clojure -X:build:drivers:build/drivers
```

### 2. 路径问题

Windows 使用反斜杠 `\` 作为路径分隔符,但在配置文件中建议使用正斜杠 `/` 或双反斜杠 `\\`。

## 详细配置说明

### 前端开发配置

#### 可用的前端构建命令

```bash
# 构建一次(不监听变化)
yarn build

# 热重载模式(推荐开发使用,保持 React 组件状态)
yarn build-hot

# 监听模式(重载但不保持状态)
yarn build-watch

# 仅构建 ClojureScript
yarn build:cljs

# 仅构建 JavaScript
yarn build:js
```

#### 启用 ESLint (默认禁用以加快构建)

```bash
USE_ESLINT=true yarn build-hot
```

#### 更好的 Source Maps (用于调试)

```bash
BETTER_SOURCE_MAPS=true yarn dev
```

### 后端开发配置

#### 启动后端的多种方式

```bash
# 基础开发模式
clojure -M:run

# 包含所有驱动
clojure -M:run:drivers

# 包含企业版功能
clojure -M:run:ee

# 完整开发环境(驱动 + 企业版)
clojure -M:run:dev:drivers:drivers-dev:ee:ee-dev
```

#### 从 REPL 启动

```clojure
;; 在 Clojure REPL 中执行
(do (dev) (start!))
```

### 配置应用数据库

#### 默认配置 (H2 数据库)

默认情况下,Metabase 使用嵌入式 H2 数据库,无需额外配置。

#### 使用 PostgreSQL (推荐)

**方法 1: 环境变量**

在 Windows PowerShell 中:
```powershell
$env:MB_DB_TYPE="postgres"
$env:MB_DB_HOST="localhost"
$env:MB_DB_PORT="5432"
$env:MB_DB_USER="your_username"
$env:MB_DB_DBNAME="metabase"
$env:MB_DB_PASS="your_password"

clojure -M:run
```

在 Windows CMD 中:
```cmd
set MB_DB_TYPE=postgres
set MB_DB_HOST=localhost
set MB_DB_PORT=5432
set MB_DB_USER=your_username
set MB_DB_DBNAME=metabase
set MB_DB_PASS=your_password

clojure -M:run
```

**方法 2: 使用连接字符串**

```bash
clojure -M:run -Dmb.db.connection.uri=postgres://user:password@localhost:5432/metabase
```

**方法 3: 创建 `.lein-env` 文件**

在项目根目录创建 `.lein-env` 文件:

```clojure
{:mb-db-type   "postgres"
 :mb-db-host   "localhost"
 :mb-db-user   "your_username"
 :mb-db-dbname "metabase"
 :mb-db-pass   "your_password"}
```

**方法 4: 全局配置文件**

编辑 `~/.clojure/deps.edn`:

```clojure
{:aliases
 {:user
  {:jvm-opts
   ["-Dmb.db.host=localhost"
    "-Dmb.db.type=postgres"
    "-Dmb.db.user=your_username"
    "-Dmb.db.dbname=metabase"
    "-Dmb.db.pass=your_password"]}}}
```

## 构建数据库驱动

Metabase 支持多种数据库,驱动位于 `modules/drivers/` 目录下。

### 构建单个驱动

```bash
# 构建 MongoDB 驱动
./bin/build-driver.sh mongo

# 构建 PostgreSQL 驱动
./bin/build-driver.sh postgres

# 构建 MySQL 驱动
./bin/build-driver.sh mysql
```

### 构建所有驱动

```bash
./bin/build-drivers.sh
```

### Windows 上构建驱动

如果无法运行 shell 脚本,可以直接使用 Clojure 命令:

```bash
# 构建所有驱动
clojure -X:build:drivers:build/drivers

# 构建特定驱动(例如 mongo)
clojure -X:build:drivers:build/driver :driver mongo
```

### 在开发中包含驱动

```bash
# 运行时包含驱动
clojure -M:run:drivers

# 测试时包含驱动
clojure -X:dev:drivers:drivers-dev:test
```

## 使用 Docker 进行开发

项目提供了 `dev/docker-compose.yml` 用于快速搭建开发环境。

### 启动 PostgreSQL 应用数据库

```bash
# 在项目根目录执行
COMPOSE_PROFILES=postgresappdb docker-compose --file dev/docker-compose.yml up
```

这会启动:
- PostgreSQL 数据库 (端口 5432)
- 数据库名: `metabase`
- 用户名: `mbuser`
- 密码: `password`

### 启动测试数据仓库

```bash
# PostgreSQL 14 测试数据
COMPOSE_PROFILES=postgres14data docker-compose --file dev/docker-compose.yml up

# MySQL 5.7 测试数据
COMPOSE_PROFILES=mysql57data docker-compose --file dev/docker-compose.yml up

# MongoDB 测试数据
COMPOSE_PROFILES=mongodata docker-compose --file dev/docker-compose.yml up
```

### 组合使用多个服务

```bash
# 应用数据库 + PostgreSQL 测试数据 + MySQL 测试数据
COMPOSE_PROFILES=postgresappdb,postgres14data,mysql57data docker-compose --file dev/docker-compose.yml up
```

### 在容器中运行 Metabase

```bash
# 完整的容器化开发环境
COMPOSE_PROFILES=postgresappdb,postgres14data,dev-app docker-compose --file dev/docker-compose.yml up
```

这会:
- 启动 Metabase 应用 (端口 3001)
- 暴露 REPL 端口 (50505)
- 挂载项目目录到容器

## 运行测试

### 前端测试

```bash
# 运行所有前端测试(单元测试 + Cypress E2E 测试)
yarn test

# 仅运行单元测试
yarn test-unit

# 监听模式运行单元测试
yarn test-unit-watch

# 运行 Cypress E2E 测试
yarn test-cypress

# 运行时区测试
yarn test-timezones
```

### 后端测试

```bash
# 运行所有 OSS 测试
clojure -X:dev:test

# 运行 OSS + 企业版测试
clojure -X:dev:ee:ee-dev:test

# 运行特定命名空间的测试
clojure -X:dev:test :only metabase.api.database-test

# 运行特定测试
clojure -X:dev:test :only metabase.api.database-test/my-test

# 运行特定目录的测试
clojure -X:dev:test :only '"test/metabase/api"'
```

### 测试特定数据库驱动

```bash
# 测试 PostgreSQL 和 MySQL 驱动
DRIVERS=postgres,mysql clojure -X:dev:drivers:drivers-dev:test
```

## 代码检查和格式化

### 前端代码检查

```bash
# 运行所有检查
yarn lint

# ESLint 检查
yarn lint-eslint

# 自动修复 ESLint 问题
yarn eslint-fix

# Prettier 检查
yarn lint-prettier

# 自动格式化代码
yarn prettier

# CSS 检查
yarn lint-css

# TypeScript 类型检查
yarn type-check
```

### 后端代码检查

```bash
# 运行 clj-kondo (需要单独安装)
mage kondo

# 运行 Eastwood
clojure -X:dev:ee:ee-dev:drivers:drivers-dev:eastwood

# 检查命名空间
clojure -X:dev:ee:ee-dev:drivers:drivers-dev:test:namespace-checker
```

## 常见问题和解决方案

### 1. 端口冲突

如果默认端口被占用,可以修改:

**前端端口**:
```bash
MB_FRONTEND_DEV_PORT=8089 yarn build-hot
```

**后端端口**:
```bash
clojure -M:run -Dmb.jetty.port=3001
```

### 2. 内存不足

增加 Node.js 内存限制:
```bash
NODE_OPTIONS=--max-old-space-size=8192 yarn build-hot
```

### 3. 文件监听问题

某些系统可能无法正确检测文件变化,可以在 `rspack.main.config.js` 中启用轮询:

```javascript
// 取消注释 watchOptions 配置
watchOptions: {
  poll: 1000
}
```

### 4. ClojureScript 编译缓存问题

清理缓存:
```bash
# 清理开发环境缓存
yarn clean-dev:cljs

# 清理发布版本缓存
yarn clean-release:cljs

# 清理所有 CLJS 缓存
yarn clean:cljs
```

### 5. JavaScript 依赖问题

```bash
# 删除 node_modules 并重新安装
rm -rf node_modules
yarn install

# 清理 Yarn 缓存
yarn cache clean
```

### 6. 驱动构建失败

确保已安装 Clojure CLI 并检查网络连接:
```bash
# 检查 Clojure 版本
clojure --version

# 预下载所有依赖
clojure -P -X:dev:drivers:drivers-dev
```

## 开发工作流建议

### 推荐的开发流程

1. **首次设置**:
   ```bash
   # 安装依赖
   yarn install
   
   # 构建驱动
   ./bin/build-drivers.sh
   ```

2. **日常开发**:
   ```bash
   # 使用一键启动
   yarn dev
   ```
   
   或者分别启动:
   ```bash
   # 终端 1: 前端
   yarn build-hot
   
   # 终端 2: 后端
   clojure -M:run
   ```

3. **访问应用**:
   - 打开浏览器访问: `http://localhost:3000`
   - 首次访问会进入设置向导

4. **代码修改**:
   - 前端代码修改会自动热重载
   - 后端代码修改需要在 REPL 中重新加载命名空间

### 使用 REPL 进行开发

启动 REPL:
```bash
clojure -M:dev:drivers:drivers-dev:ee:ee-dev
```

在 REPL 中:
```clojure
;; 启动服务器
(do (dev) (start!))

;; 停止服务器
(stop!)

;; 重启服务器
(restart!)

;; 重新加载命名空间
(require 'some.namespace :reload)

;; 运行测试
(clojure.test/run-tests 'metabase.some-test)
```

## 多实例运行

如果需要在同一台机器上运行多个 Metabase 实例:

```bash
# 实例 1 (默认端口)
# 终端 1
yarn build-hot
# 终端 2
clojure -M:run

# 实例 2 (自定义端口)
# 终端 3
MB_FRONTEND_DEV_PORT=8089 yarn build-hot
# 终端 4
clojure -M:run -Dmb.jetty.port=3001 -Dmb.frontend.dev.port=8089
```

## 生产构建

虽然这是开发指南,但了解生产构建也很有用:

```bash
# 构建前端生产版本
yarn build-release

# 构建后端生产版本
clojure -M:build

# 构建完整的 JAR 包
./bin/build.sh
```

## 额外资源

- **开发者文档**: `docs/developers-guide/`
- **API 文档**: `docs/api.html`
- **驱动开发指南**: `docs/developers-guide/drivers/start.md`
- **贡献指南**: `CONTRIBUTING.md`
- **官方文档**: https://www.metabase.com/docs/

## 总结

最简单的本地运行方式:

```bash
# 1. 确保已安装 Node.js (>=22), Yarn, Java, Clojure CLI
# 2. 在项目根目录执行
yarn dev
# 3. 访问 http://localhost:3000
```

如果遇到问题,可以:
1. 检查所有依赖是否正确安装
2. 查看终端输出的错误信息
3. 清理缓存后重试
4. 参考 `docs/developers-guide/devenv.md` 获取更多帮助
