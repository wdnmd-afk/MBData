# Metabase 删除企业版功能指南

> ⚠️ **重要警告**: 删除企业版功能会导致项目无法正常编译和运行!  
> Metabase 的开源版和企业版代码是紧密耦合的,不建议直接删除。

---

## 目录

- [为什么不建议删除](#为什么不建议删除)
- [企业版功能概览](#企业版功能概览)
- [删除方案](#删除方案)
- [风险评估](#风险评估)
- [替代方案](#替代方案)

---

## 为什么不建议删除

### 1. 代码耦合度高

Metabase 的架构设计中,企业版功能不是简单的插件,而是深度集成在核心代码中:

```
开源核心代码
    ↓ 依赖
企业版功能接口
    ↓ 实现
企业版具体功能
```

**问题**:
- 开源代码中有大量对企业版功能的引用
- 删除企业版代码会导致编译错误
- 需要修改数百个文件才能完全移除

### 2. 功能检测机制

Metabase 使用功能特性检测来判断是否启用企业版功能:

```clojure
;; 后端检测
(premium-features/enable-advanced-permissions?)
(premium-features/enable-whitelabel?)
(premium-features/enable-audit-app?)

// 前端检测
getSetting("token-features")
hasFeature("advanced-permissions")
```

**设计理念**:
- 企业版功能默认存在但未激活
- 通过许可证密钥激活
- 未激活时功能不可用但代码仍存在

### 3. 影响范围

删除企业版会影响:

| 影响范围 | 具体内容 |
|---------|---------|
| **后端代码** | 525+ 个文件 (enterprise/backend/) |
| **前端代码** | 1402+ 个文件 (enterprise/frontend/) |
| **核心代码引用** | 600+ 处引用 |
| **API 端点** | 50+ 个企业版 API |
| **数据库模型** | 20+ 个企业版表 |
| **权限系统** | 深度集成 |
| **UI 组件** | 200+ 个组件 |

---

## 企业版功能概览

### 后端功能模块

```
enterprise/backend/src/metabase_enterprise/
├── action_v2/                    # 高级操作功能
├── advanced_config/              # 高级配置
├── advanced_permissions/         # 高级权限管理
├── ai_entity_analysis/           # AI 实体分析
├── ai_sql_fixer/                 # AI SQL 修复
├── ai_sql_generation/            # AI SQL 生成
├── analytics/                    # 企业分析
├── api/                          # 企业 API
├── audit_app/                    # 审计应用
├── cache/                        # 缓存管理
├── content_management/           # 内容管理
├── dashboard_subscription_filters/ # 仪表板订阅过滤
├── email/                        # 企业邮件功能
├── embedding/                    # 嵌入功能
├── hosting/                      # 托管功能
├── llm/                          # LLM 集成
├── sandbox/                      # 数据沙箱
├── scim/                         # SCIM 用户同步
├── serialization/                # 序列化
├── sso/                          # SSO 单点登录
├── upload_management/            # 上传管理
└── whitelabel/                   # 白标定制
```

### 前端功能模块

```
enterprise/frontend/src/metabase-enterprise/
├── ai/                           # AI 功能 UI
├── audit_app/                    # 审计应用 UI
├── caching/                      # 缓存设置 UI
├── collections/                  # 集合管理 UI
├── content_management/           # 内容管理 UI
├── embedding/                    # 嵌入 UI
├── feature_level_permissions/    # 功能级权限 UI
├── hosting/                      # 托管 UI
├── license/                      # 许可证 UI
├── llm/                          # LLM UI
├── moderation/                   # 内容审核 UI
├── model_persistence/            # 模型持久化 UI
├── sandbox/                      # 沙箱 UI
├── scim/                         # SCIM UI
├── settings/                     # 企业设置 UI
├── sharing/                      # 分享功能 UI
├── snippets/                     # 代码片段 UI
└── whitelabel/                   # 白标 UI
```

---

## 删除方案

### 方案 1: 完全删除(不推荐)

#### 步骤 1: 删除企业版目录

```bash
# ⚠️ 危险操作!会导致项目无法编译
rm -rf enterprise/
```

#### 步骤 2: 修改依赖配置

**deps.edn** (后端依赖):
```clojure
;; 删除所有包含 :metabase-enterprise 的路径
:paths ["src"
        "resources"
        ;; "enterprise/backend/src"  ; 删除这行
        ]

;; 删除企业版相关的 alias
;; :ee { ... }  ; 删除整个 :ee 配置
```

**package.json** (前端依赖):
```json
{
  "scripts": {
    // 删除所有包含 enterprise 的脚本
  }
}
```

#### 步骤 3: 删除核心代码中的引用

需要修改的文件数量: **600+**

**示例 1**: 删除权限检查
```clojure
;; src/metabase/api/permissions.clj
;; 删除或注释掉企业版权限检查
(defn- check-advanced-permissions []
  ;; (when (premium-features/enable-advanced-permissions?)
  ;;   ...)
  nil)  ; 替换为空实现
```

**示例 2**: 删除 UI 组件引用
```typescript
// frontend/src/metabase/admin/settings/components/SettingsPages.tsx
// 删除企业版设置页面导入
// import { EnterpriseSettings } from "metabase-enterprise/settings";

// 删除企业版路由
const routes = [
  // { path: "/admin/settings/enterprise", component: EnterpriseSettings },
];
```

#### 步骤 4: 处理编译错误

```bash
# 尝试编译
yarn build-hot

# 会看到大量错误,需要逐个修复:
# - Module not found: 'metabase-enterprise/...'
# - Cannot resolve 'metabase_enterprise...'
# - Undefined function: premium-features/...
```

**预计需要修改的文件**: 200-300 个

---

### 方案 2: 禁用企业版功能(推荐)

不删除代码,只是确保企业版功能不会被激活。

#### 步骤 1: 移除许可证

```bash
# 确保没有设置许可证环境变量
unset MB_PREMIUM_EMBEDDING_TOKEN
unset MB_LICENSE_KEY

# 或者在启动时不设置
clojure -M:run
```

#### 步骤 2: 修改功能检测

**src/metabase/premium_features/core.clj**:
```clojure
(defn enable-any-premium-feature? []
  ;; 强制返回 false
  false)

(defn enable-advanced-permissions? []
  false)

(defn enable-whitelabel? []
  false)

(defn enable-audit-app? []
  false)

;; ... 其他功能检测函数都返回 false
```

#### 步骤 3: 隐藏企业版 UI

**frontend/src/metabase/lib/settings.ts**:
```typescript
// 修改设置获取函数
export function getSetting(key: string) {
  if (key === "token-features") {
    return {}; // 返回空对象,表示没有任何企业版功能
  }
  // ... 其他设置
}
```

#### 步骤 4: 移除企业版菜单

**frontend/src/metabase/admin/settings/components/SettingsPages.tsx**:
```typescript
// 过滤掉企业版设置页面
const settingsPages = ALL_SETTINGS_PAGES.filter(
  page => !page.isEnterprise
);
```

---

### 方案 3: 条件编译(最佳实践)

使用编译时标志来控制是否包含企业版代码。

#### 步骤 1: 添加编译标志

**deps.edn**:
```clojure
:aliases {
  :community {
    :jvm-opts ["-Dmetabase.edition=community"]
    :paths ["src" "resources"]
  }
  :enterprise {
    :jvm-opts ["-Dmetabase.edition=enterprise"]
    :paths ["src" "resources" "enterprise/backend/src"]
  }
}
```

#### 步骤 2: 使用社区版启动

```bash
# 只启动社区版
clojure -M:community:run
```

#### 步骤 3: 前端条件编译

**rspack.config.js**:
```javascript
module.exports = {
  resolve: {
    alias: {
      // 社区版时,将企业版模块指向空实现
      'metabase-enterprise': process.env.EDITION === 'community'
        ? path.resolve(__dirname, 'frontend/src/metabase-enterprise-stub')
        : path.resolve(__dirname, 'enterprise/frontend/src/metabase-enterprise'),
    },
  },
};
```

**frontend/src/metabase-enterprise-stub/index.ts**:
```typescript
// 企业版功能的空实现
export const EnterpriseSettings = () => null;
export const AuditApp = () => null;
export const WhiteLabelSettings = () => null;
// ... 其他企业版组件的空实现
```

---

## 风险评估

### 完全删除的风险

| 风险 | 严重程度 | 影响 |
|-----|---------|------|
| **编译失败** | ⚠️⚠️⚠️ 极高 | 项目无法构建 |
| **运行时错误** | ⚠️⚠️⚠️ 极高 | 应用崩溃 |
| **功能缺失** | ⚠️⚠️ 高 | 部分核心功能不可用 |
| **数据库迁移失败** | ⚠️⚠️ 高 | 无法升级数据库 |
| **测试失败** | ⚠️⚠️ 高 | 600+ 个测试失败 |
| **维护困难** | ⚠️⚠️⚠️ 极高 | 无法合并上游更新 |

### 工作量估算

| 任务 | 预计时间 | 难度 |
|-----|---------|------|
| 删除企业版目录 | 5 分钟 | 简单 |
| 修改依赖配置 | 1 小时 | 中等 |
| 删除代码引用 | 40-80 小时 | 困难 |
| 修复编译错误 | 20-40 小时 | 困难 |
| 修复运行时错误 | 10-20 小时 | 困难 |
| 修复测试 | 20-40 小时 | 困难 |
| **总计** | **90-180 小时** | **非常困难** |

---

## 替代方案

### 方案 A: 使用官方社区版

Metabase 提供官方的社区版构建,已经移除了企业版功能。

```bash
# 下载社区版 JAR
wget https://downloads.metabase.com/v0.51.0/metabase.jar

# 运行
java -jar metabase.jar
```

**优点**:
- ✅ 官方支持
- ✅ 无企业版功能
- ✅ 稳定可靠
- ✅ 可以升级

**缺点**:
- ❌ 无法修改源代码
- ❌ 需要下载预编译包

### 方案 B: Fork 并维护社区版

创建自己的 Fork,移除企业版功能并持续维护。

```bash
# 1. Fork 项目
git clone https://github.com/你的用户名/metabase.git
cd metabase

# 2. 创建社区版分支
git checkout -b community-edition

# 3. 删除企业版
rm -rf enterprise/

# 4. 修改代码(参考上面的步骤)

# 5. 提交
git add .
git commit -m "Remove enterprise features"

# 6. 推送
git push origin community-edition
```

**优点**:
- ✅ 完全控制代码
- ✅ 可以自定义功能
- ✅ 可以分享给他人

**缺点**:
- ❌ 需要大量工作
- ❌ 难以合并上游更新
- ❌ 需要持续维护

### 方案 C: 隐藏企业版 UI(最简单)

只隐藏企业版相关的 UI 元素,不删除代码。

#### 步骤 1: 创建自定义 CSS

**frontend/src/metabase/css/custom.css**:
```css
/* 隐藏企业版相关的 UI 元素 */

/* 隐藏"升级到企业版"按钮 */
[data-testid="upgrade-button"],
.upgrade-button,
.enterprise-upgrade {
  display: none !important;
}

/* 隐藏企业版功能标签 */
.enterprise-badge,
.pro-badge,
[data-badge="enterprise"] {
  display: none !important;
}

/* 隐藏企业版设置页面 */
[href*="/admin/settings/enterprise"],
[href*="/admin/settings/whitelabel"],
[href*="/admin/settings/audit"] {
  display: none !important;
}

/* 隐藏许可证相关 */
.license-input,
.license-status,
[data-testid="license-section"] {
  display: none !important;
}
```

#### 步骤 2: 导入自定义 CSS

**frontend/src/metabase/app.js**:
```javascript
import "./css/custom.css";
```

#### 步骤 3: 重新编译

```bash
yarn build-hot
```

**优点**:
- ✅ 简单快速(30 分钟)
- ✅ 不影响编译
- ✅ 可以随时恢复
- ✅ 不影响升级

**缺点**:
- ❌ 企业版代码仍然存在
- ❌ 只是视觉上隐藏
- ❌ 熟悉的用户仍可能访问

---

## 实施建议

### 推荐方案排序

1. **方案 A: 使用官方社区版** ⭐⭐⭐⭐⭐
   - 最简单、最稳定
   - 适合: 只想使用,不需要修改代码

2. **方案 C: 隐藏企业版 UI** ⭐⭐⭐⭐
   - 简单快速
   - 适合: 需要修改代码,但不想删除企业版

3. **方案 2: 禁用企业版功能** ⭐⭐⭐
   - 中等难度
   - 适合: 需要确保企业版功能不被激活

4. **方案 3: 条件编译** ⭐⭐
   - 较复杂
   - 适合: 需要维护两个版本

5. **方案 B: Fork 并维护** ⭐
   - 非常复杂
   - 适合: 有专业团队维护

6. **方案 1: 完全删除** ❌
   - 不推荐
   - 风险太高,工作量太大

### 快速实施(方案 C)

如果你只是想隐藏企业版 UI,按照以下步骤操作:

```bash
# 1. 创建自定义 CSS 文件
cat > frontend/src/metabase/css/custom.css << 'EOF'
/* 隐藏企业版 UI */
[data-testid="upgrade-button"],
.enterprise-badge,
[href*="/admin/settings/enterprise"] {
  display: none !important;
}
EOF

# 2. 在 app.js 中导入
echo 'import "./css/custom.css";' >> frontend/src/metabase/app.js

# 3. 重新编译
yarn build-hot
```

**完成!** 企业版相关的 UI 元素已被隐藏。

---

## 常见问题

### Q1: 删除企业版会影响性能吗?

**A**: 不会。企业版代码只有在激活时才会运行,未激活时不会影响性能。

### Q2: 可以只删除某些企业版功能吗?

**A**: 理论上可以,但非常复杂。每个功能都与核心代码有依赖关系。

### Q3: 删除后还能升级 Metabase 吗?

**A**: 如果完全删除,几乎不可能合并上游更新。建议使用方案 C(隐藏 UI)。

### Q4: 企业版代码是开源的吗?

**A**: 是的,企业版代码在 `enterprise/` 目录下,使用 MCL(Metabase Commercial License)许可证。

### Q5: 如何判断某个功能是企业版的?

**A**: 查看代码路径:
- `enterprise/` 目录下的都是企业版
- 使用 `premium-features/enable-*` 检查的是企业版功能
- UI 中有"Pro"或"Enterprise"标签的是企业版

---

## 总结

### 关键要点

1. **不建议删除**: 企业版代码与核心代码紧密耦合
2. **推荐方案**: 使用官方社区版或隐藏企业版 UI
3. **风险评估**: 完全删除需要 90-180 小时工作量
4. **替代方案**: 多种方案可选,根据需求选择

### 最终建议

**如果你的目标是**:
- ✅ 使用 Metabase 而不需要企业版功能 → 使用官方社区版
- ✅ 修改代码但不想看到企业版 UI → 使用方案 C(隐藏 UI)
- ✅ 确保企业版功能不被激活 → 使用方案 2(禁用功能)
- ❌ 完全删除企业版代码 → 不推荐,风险太高

### 快速决策树

```
需要修改源代码?
├─ 否 → 使用官方社区版 JAR
└─ 是 → 需要删除企业版代码?
    ├─ 否 → 隐藏企业版 UI(方案 C)
    └─ 是 → 有专业团队维护?
        ├─ 是 → Fork 并维护(方案 B)
        └─ 否 → 不推荐删除,使用方案 C
```

---

## 相关资源

- [Metabase 许可证说明](https://github.com/metabase/metabase/blob/master/LICENSE.txt)
- [企业版功能列表](https://www.metabase.com/pricing/)
- [社区版下载](https://www.metabase.com/start/oss/)

---

**最后提醒**: 删除企业版功能是一个复杂且高风险的操作。在做出决定前,请仔细评估你的需求和资源。
