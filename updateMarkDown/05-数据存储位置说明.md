# Metabase 数据存储位置说明

## 当前数据库配置

### 使用的数据库类型

你当前使用的是 **H2 数据库**(嵌入式数据库),这是 Metabase 开发环境的默认配置。

**特点**:
- ✅ 无需额外安装数据库服务器
- ✅ 适合开发和测试
- ⚠️ **不推荐用于生产环境**
- ⚠️ 需要定期备份数据库文件

---

## 数据文件位置

### 主数据库文件

**位置**: `e:\github\metabase\metabase.db.mv.db`

**大小**: 约 1.7 MB (1,695,744 字节)

**最后修改**: 2025-11-20 08:43:18

**存储内容**:
- ✅ 用户账户信息 (用户名、邮箱、密码哈希等)
- ✅ 用户设置 (语言偏好、主题等)
- ✅ 数据库连接配置 (你创建的所有数据源连接)
- ✅ 仪表板 (Dashboards)
- ✅ 问题/查询 (Questions)
- ✅ 集合 (Collections)
- ✅ 权限设置
- ✅ 系统设置
- ✅ 所有元数据

### 数据库跟踪文件

**位置**: `e:\github\metabase\metabase.db.trace.db`

**大小**: 约 33 KB

**用途**: H2 数据库的跟踪日志文件,用于调试和错误追踪

---

## 数据库表结构

H2 数据库包含以下主要表:

### 用户相关表
- `core_user` - 用户账户信息
- `permissions_group` - 权限组
- `permissions_group_membership` - 用户-权限组关系

### 数据源相关表
- `metabase_database` - 数据库连接配置
- `metabase_table` - 表元数据
- `metabase_field` - 字段元数据

### 内容相关表
- `report_dashboard` - 仪表板
- `report_card` - 问题/查询
- `collection` - 集合
- `dashboard_card` - 仪表板卡片

### 系统相关表
- `setting` - 系统设置
- `activity` - 活动日志
- `query_execution` - 查询执行历史

---

## 配置详情

### 默认配置

根据源代码 (`src/metabase/config/core.clj`):

```clojure
{:mb-db-type "h2"
 :mb-db-file "metabase.db"}
```

### 数据库连接字符串

实际的 H2 连接字符串:
```
jdbc:h2:file:E:\github\metabase\metabase.db
```

### H2 连接参数

```clojure
{:DB_CLOSE_DELAY -1        ; 直到 JVM 关闭才关闭数据库
 :MVCC true                 ; 启用多版本并发控制
 :DEFRAG_ALWAYS true        ; 关闭时整理碎片
 :LOCK_TIMEOUT 60000}       ; 锁超时 60 秒
```

---

## 如何备份数据

### 方法 1: 直接复制文件(推荐用于开发环境)

```bash
# 1. 停止 Metabase 后端(Ctrl+C)

# 2. 复制数据库文件
cp metabase.db.mv.db metabase.db.mv.db.backup
cp metabase.db.trace.db metabase.db.trace.db.backup

# 3. 或者创建带时间戳的备份
cp metabase.db.mv.db "metabase.db.mv.db.backup.$(date +%Y%m%d_%H%M%S)"
```

### 方法 2: 使用 Metabase 内置命令

```bash
# 导出到 H2 文件
clojure -M:run dump-to-h2 /path/to/backup.db

# 这会创建:
# - backup.db.mv.db
# - backup.db.trace.db
```

### 方法 3: 定期自动备份脚本

创建 `backup.sh`:
```bash
#!/bin/bash
BACKUP_DIR="./backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp metabase.db.mv.db "$BACKUP_DIR/metabase.db.mv.db.$TIMESTAMP"

# 只保留最近 7 天的备份
find $BACKUP_DIR -name "metabase.db.mv.db.*" -mtime +7 -delete

echo "Backup completed: $BACKUP_DIR/metabase.db.mv.db.$TIMESTAMP"
```

---

## 如何恢复数据

### 从备份文件恢复

```bash
# 1. 停止 Metabase

# 2. 删除当前数据库
rm metabase.db.mv.db
rm metabase.db.trace.db

# 3. 恢复备份
cp metabase.db.mv.db.backup metabase.db.mv.db
cp metabase.db.trace.db.backup metabase.db.trace.db

# 4. 重新启动 Metabase
clojure -M:run
```

---

## 迁移到生产数据库

### 为什么要迁移?

H2 数据库的限制:
- ❌ 不支持多实例部署
- ❌ 性能有限
- ❌ 文件损坏风险较高
- ❌ 不适合大规模使用

### 推荐的生产数据库

1. **PostgreSQL** (强烈推荐)
2. **MySQL** / **MariaDB**

### 迁移步骤

#### 1. 准备目标数据库

**PostgreSQL 示例**:
```sql
CREATE DATABASE metabase;
CREATE USER metabase WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE metabase TO metabase;
```

#### 2. 配置环境变量

创建 `.env` 文件或设置环境变量:

```bash
# PostgreSQL
export MB_DB_TYPE=postgres
export MB_DB_DBNAME=metabase
export MB_DB_PORT=5432
export MB_DB_USER=metabase
export MB_DB_PASS=your_password
export MB_DB_HOST=localhost

# 或者使用连接字符串
export MB_DB_CONNECTION_URI="postgresql://metabase:your_password@localhost:5432/metabase"
```

**MySQL 示例**:
```bash
export MB_DB_TYPE=mysql
export MB_DB_DBNAME=metabase
export MB_DB_PORT=3306
export MB_DB_USER=metabase
export MB_DB_PASS=your_password
export MB_DB_HOST=localhost
```

#### 3. 从 H2 迁移数据

```bash
# 方法 A: 使用 Metabase 命令行工具
clojure -M:run load-from-h2

# 方法 B: 指定 H2 文件路径
clojure -M:run load-from-h2 /path/to/metabase.db
```

#### 4. 验证迁移

```bash
# 启动 Metabase(使用新数据库)
clojure -M:run

# 检查日志确认连接到了正确的数据库
# 应该看到类似:
# "Successfully verified PostgreSQL connection"
```

---

## 查看数据库内容

### 使用 H2 Console (Web 界面)

```bash
# 1. 下载 H2 数据库
# 访问: https://www.h2database.com/html/download.html

# 2. 启动 H2 Console
java -jar h2*.jar

# 3. 在浏览器中打开 http://localhost:8082

# 4. 连接信息:
# JDBC URL: jdbc:h2:file:E:/github/metabase/metabase.db
# User Name: (留空)
# Password: (留空)
```

### 使用 SQL 查询

连接后可以执行查询:

```sql
-- 查看所有用户
SELECT * FROM core_user;

-- 查看数据库连接
SELECT * FROM metabase_database;

-- 查看仪表板
SELECT * FROM report_dashboard;

-- 查看问题/查询
SELECT * FROM report_card;

-- 查看系统设置
SELECT * FROM setting;
```

---

## 常见问题

### Q1: 数据库文件在哪里?

**A**: 默认在项目根目录: `e:\github\metabase\metabase.db.mv.db`

可以通过环境变量 `MB_DB_FILE` 修改位置:
```bash
export MB_DB_FILE=/custom/path/metabase.db
```

### Q2: 如何更改数据库位置?

**方法 1**: 设置环境变量
```bash
export MB_DB_FILE=/new/path/metabase.db
clojure -M:run
```

**方法 2**: 移动文件并创建符号链接
```bash
mv metabase.db.mv.db /new/path/
ln -s /new/path/metabase.db.mv.db metabase.db.mv.db
```

### Q3: 数据库文件损坏怎么办?

**症状**:
- 启动时报错
- 数据丢失
- 无法连接

**解决方案**:
1. 从备份恢复(见上文)
2. 如果没有备份,尝试 H2 数据库修复工具
3. 最坏情况:重新初始化(会丢失所有数据)

### Q4: 如何清空数据重新开始?

```bash
# 1. 停止 Metabase

# 2. 删除数据库文件
rm metabase.db.mv.db
rm metabase.db.trace.db

# 3. 重新启动
clojure -M:run

# 会自动创建新的空数据库
```

### Q5: 数据库文件会自动增长吗?

**是的**,随着使用会增长:
- 添加用户
- 创建仪表板和问题
- 查询历史记录
- 活动日志

**优化**:
- H2 会在关闭时自动整理碎片 (`DEFRAG_ALWAYS`)
- 定期清理旧的查询历史
- 考虑迁移到生产数据库

---

## 数据库文件说明

### metabase.db.mv.db

**格式**: H2 MVStore (多版本存储)

**特点**:
- 支持事务
- ACID 兼容
- 自动压缩
- 崩溃恢复

### metabase.db.trace.db

**格式**: 文本文件

**内容**: 数据库操作跟踪日志

**用途**:
- 调试 SQL 问题
- 性能分析
- 错误诊断

---

## 安全建议

### 开发环境

✅ **推荐做法**:
- 定期备份数据库文件
- 不要提交数据库文件到 Git
- 使用 `.gitignore` 排除:
  ```
  metabase.db.mv.db
  metabase.db.trace.db
  ```

### 生产环境

✅ **必须做到**:
- 使用 PostgreSQL 或 MySQL
- 配置数据库备份策略
- 启用 SSL 连接
- 限制数据库访问权限
- 定期更新数据库软件

---

## 监控数据库大小

```bash
# 查看数据库文件大小
ls -lh metabase.db.mv.db

# 持续监控
watch -n 60 'ls -lh metabase.db.mv.db'

# 查看磁盘使用
du -sh metabase.db*
```

---

## 总结

### 关键信息

| 项目 | 值 |
|------|-----|
| **数据库类型** | H2 (嵌入式) |
| **主文件位置** | `e:\github\metabase\metabase.db.mv.db` |
| **当前大小** | 约 1.7 MB |
| **包含数据** | 用户、数据源、仪表板、问题、设置等所有数据 |
| **备份方式** | 直接复制文件或使用 `dump-to-h2` 命令 |
| **生产建议** | 迁移到 PostgreSQL 或 MySQL |

### 快速命令参考

```bash
# 备份
cp metabase.db.mv.db metabase.db.mv.db.backup

# 恢复
cp metabase.db.mv.db.backup metabase.db.mv.db

# 迁移到 PostgreSQL
export MB_DB_TYPE=postgres
export MB_DB_CONNECTION_URI="postgresql://user:pass@localhost/metabase"
clojure -M:run load-from-h2

# 查看数据库大小
ls -lh metabase.db.mv.db
```

### 重要提醒

⚠️ **定期备份**: H2 数据库文件是你所有 Metabase 数据的唯一副本!

⚠️ **生产环境**: 如果要部署到生产环境,务必迁移到 PostgreSQL 或 MySQL!

⚠️ **Git 忽略**: 不要将数据库文件提交到版本控制系统!
