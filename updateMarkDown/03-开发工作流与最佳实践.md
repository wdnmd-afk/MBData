# Metabase é¡¹ç›®æ·±åº¦åˆ†æ - ç¬¬ä¸‰éƒ¨åˆ†: å¼€å‘å·¥ä½œæµä¸æœ€ä½³å®è·µ

> ç”Ÿæˆæ—¶é—´: 2025-11-19  
> é¡¹ç›®è·¯å¾„: e:\github\metabase

---

## ğŸ”„ å¼€å‘å·¥ä½œæµ

### REPL é©±åŠ¨å¼€å‘ (Clojure)

Metabase å¼ºè°ƒä½¿ç”¨ REPL (Read-Eval-Print Loop) è¿›è¡Œè¿­ä»£å¼å¼€å‘ã€‚

#### REPL å¼€å‘å¾ªç¯

```
1. ç¼–å†™å°å‹åŸºç¡€å‡½æ•°
     â†“
2. åœ¨ REPL ä¸­æµ‹è¯•
     â†“
3. éªŒè¯å„ç§è¾“å…¥åœºæ™¯
     â†“
4. æ•´åˆåˆ°æºä»£ç 
     â†“
5. æ„å»ºæ›´å¤æ‚çš„å‡½æ•°
     â†“
6. æŒç»­åœ¨ REPL ä¸­éªŒè¯
```

#### å¯åŠ¨ REPL

```bash
# åŸºç¡€ REPL (åŒ…å«æµ‹è¯•å‘½åç©ºé—´)
clojure -A:dev

# å¸¦é©±åŠ¨çš„ REPL
clojure -A:dev:drivers:drivers-dev

# ä¼ä¸šç‰ˆ REPL
clojure -A:dev:ee:ee-dev
```

#### ä½¿ç”¨ REPL å·¥å…· (mage)

```bash
# åŠ è½½å¹¶è°ƒç”¨å‡½æ•°
./bin/mage -repl --namespace metabase.query-processor.core '(process-query query)'

# åªåŠ è½½å‘½åç©ºé—´
./bin/mage -repl --namespace metabase.models.card

# ç›´æ¥æ‰§è¡Œä»£ç 
./bin/mage -repl '(+ 1 2 3)'
```

#### ä»£ç å¯è¯»æ€§æ£€æŸ¥

```bash
# æ£€æŸ¥æ•´ä¸ªæ–‡ä»¶
./bin/mage -check-readable src/metabase/query_processor/core.clj

# æ£€æŸ¥ç‰¹å®šè¡Œ
./bin/mage -check-readable src/metabase/query_processor/core.clj 42
```

**é‡è¦è§„åˆ™**:
- æ¯æ¬¡ä¿®æ”¹ Clojure ä»£ç åå¿…é¡»è¿è¡Œ `-check-readable`
- ä»”ç»†æ³¨æ„æ‹¬å·çš„æ•°é‡
- ç¡®ä¿ä»£ç å¯ä»¥è¢«æ­£ç¡®è§£æ

---

## ğŸ’» å‰ç«¯å¼€å‘å·¥ä½œæµ

### ç»„ä»¶å¼€å‘æµç¨‹

#### 1. åˆ›å»ºæ–°ç»„ä»¶

```typescript
// frontend/src/metabase/components/MyComponent/MyComponent.tsx

import React from "react";
import { Box, Text } from "metabase/ui";

interface MyComponentProps {
  title: string;
  onClick?: () => void;
}

export function MyComponent({ title, onClick }: MyComponentProps) {
  return (
    <Box onClick={onClick}>
      <Text>{title}</Text>
    </Box>
  );
}
```

#### 2. æ·»åŠ æ ·å¼

```typescript
// MyComponent.styled.tsx
import styled from "@emotion/styled";

export const Container = styled.div`
  padding: 1rem;
  background-color: var(--mb-color-bg-light);
`;
```

æˆ–ä½¿ç”¨ CSS Modules:

```css
/* MyComponent.module.css */
.container {
  padding: 1rem;
  background-color: var(--mb-color-bg-light);
}
```

#### 3. ç¼–å†™æµ‹è¯•

```typescript
// MyComponent.unit.spec.tsx
import { render, screen } from "@testing-library/react";
import { MyComponent } from "./MyComponent";

describe("MyComponent", () => {
  it("åº”è¯¥æ˜¾ç¤ºæ ‡é¢˜", () => {
    render(<MyComponent title="æµ‹è¯•æ ‡é¢˜" />);
    expect(screen.getByText("æµ‹è¯•æ ‡é¢˜")).toBeInTheDocument();
  });
});
```

#### 4. åˆ›å»º Storybook æ•…äº‹

```typescript
// MyComponent.stories.tsx
import type { StoryObj } from "@storybook/react";
import { MyComponent } from "./MyComponent";

export default {
  title: "Components/MyComponent",
  component: MyComponent,
};

export const Default: StoryObj<typeof MyComponent> = {
  args: {
    title: "é»˜è®¤æ ‡é¢˜",
  },
};
```

### çƒ­é‡è½½å¼€å‘

```bash
# å¯åŠ¨å‰ç«¯çƒ­é‡è½½
yarn build-hot

# æ–‡ä»¶ä¿å­˜åä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘
# React ç»„ä»¶ä¿æŒçŠ¶æ€
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
yarn test-unit

# ç›‘å¬æ¨¡å¼
yarn test-unit-watch

# è¿è¡Œç‰¹å®šæ–‡ä»¶
yarn test-unit-keep-cljs frontend/test/metabase/components/MyComponent.unit.spec.tsx

# è¿è¡ŒåŒ¹é…æ¨¡å¼çš„æµ‹è¯•
yarn test-unit-keep-cljs -t "MyComponent"
```

### ä»£ç æ£€æŸ¥

```bash
# ESLint æ£€æŸ¥
yarn lint-eslint-pure

# Prettier æ ¼å¼åŒ–æ£€æŸ¥
yarn lint-prettier-pure

# CSS æ£€æŸ¥
yarn lint-css

# TypeScript ç±»å‹æ£€æŸ¥
yarn type-check-pure

# è‡ªåŠ¨ä¿®å¤é—®é¢˜
yarn eslint-fix
yarn prettier
```

---

## ğŸ”¨ åç«¯å¼€å‘å·¥ä½œæµ

### åŠŸèƒ½å¼€å‘æ­¥éª¤

#### 1. åˆ›å»ºæ¨¡å—ç»“æ„

```
src/metabase/my_feature/
â”œâ”€â”€ core.clj           # æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ models.clj         # æ•°æ®æ¨¡å‹
â”œâ”€â”€ schema.clj         # Malli éªŒè¯
â”œâ”€â”€ api.clj            # REST API
â”œâ”€â”€ settings.clj       # é…ç½®é¡¹
â”œâ”€â”€ events.clj         # äº‹ä»¶å¤„ç†
â”œâ”€â”€ task.clj           # å®šæ—¶ä»»åŠ¡
â””â”€â”€ init.clj           # åˆå§‹åŒ–
```

#### 2. å®ç°æ ¸å¿ƒé€»è¾‘

```clojure
;; src/metabase/my_feature/core.clj
(ns metabase.my-feature.core
  (:require
   [metabase.util :as u]
   [toucan2.core :as t2]))

(defn process-data
  "å¤„ç†æ•°æ®çš„æ ¸å¿ƒå‡½æ•°"
  [data options]
  (-> data
      (validate-data options)
      (transform-data)
      (save-results!)))
```

#### 3. å®šä¹‰æ•°æ®æ¨¡å‹

```clojure
;; src/metabase/my_feature/models.clj
(ns metabase.my-feature.models
  (:require
   [metabase.models.interface :as mi]
   [methodical.core :as m]
   [toucan2.core :as t2]))

(def MyModel
  "æˆ‘çš„æ¨¡å‹"
  :model/MyModel)

(t2/define-before-insert :model/MyModel
  [instance]
  (assoc instance :created_at :%now))
```

#### 4. æ·»åŠ  API ç«¯ç‚¹

```clojure
;; src/metabase/my_feature/api.clj
(ns metabase.my-feature.api
  (:require
   [compojure.core :refer [GET POST PUT DELETE]]
   [metabase.api.common :as api]
   [metabase.my-feature.core :as my-feature]))

(api/defendpoint POST "/"
  "åˆ›å»ºæ–°èµ„æº"
  [:as {{:keys [name description]} :body}]
  {name        :string
   description [:maybe :string]}
  (my-feature/create! {:name name :description description}))

(api/define-routes)
```

#### 5. æ³¨å†Œè·¯ç”±

```clojure
;; src/metabase/api_routes/routes.clj
(def ^:private +my-feature-routes
  ["/my-feature" {:middleware [api/+check-superuser]}
   my-feature/routes])
```

#### 6. ç¼–å†™æµ‹è¯•

```clojure
;; test/metabase/my_feature/core_test.clj
(ns metabase.my-feature.core-test
  (:require
   [clojure.test :refer :all]
   [metabase.my-feature.core :as my-feature]
   [metabase.test :as mt]))

(deftest ^:parallel process-data-test
  (testing "åº”è¯¥æ­£ç¡®å¤„ç†æ•°æ®"
    (is (= expected-result
           (my-feature/process-data test-data options)))))
```

#### 7. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•
./bin/mage run-tests metabase.my-feature.core-test

# è¿è¡Œæ•´ä¸ªå‘½åç©ºé—´çš„æµ‹è¯•
./bin/mage run-tests metabase.my-feature.core-test

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
clojure -X:dev:test
```

### Lint å’Œæ ¼å¼åŒ–

```bash
# Kondo Lint æ£€æŸ¥
./bin/mage kondo src/metabase/my_feature/

# æ ¼å¼åŒ–ä»£ç 
./bin/mage cljfmt-files src/metabase/my_feature/

# æ£€æŸ¥æ›´æ–°çš„æ–‡ä»¶
./bin/mage kondo-updated master
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### Clojure ä»£ç è§„èŒƒ

#### å‘½åçº¦å®š

```clojure
;; âœ… å¥½çš„å‘½å
(defn user-age [birthdate]
  (calculate-age birthdate))

(defn database-connected? [db]
  (test-connection db))

(defn update-user! [user-id updates]
  (t2/update! :model/User user-id updates))

;; âŒ ä¸å¥½çš„å‘½å
(defn get-age [bd]  ; ç¼©å†™ä¸æ¸…æ™°
  ...)

(defn db-conn [d]   ; è°“è¯åº”ä»¥ ? ç»“å°¾
  ...)

(defn update-user [uid u]  ; å‰¯ä½œç”¨å‡½æ•°åº”ä»¥ ! ç»“å°¾
  ...)
```

#### å‡½æ•°è®¾è®¡

```clojure
;; âœ… å¥½çš„å‡½æ•°è®¾è®¡
(defn process-users
  "å¤„ç†ç”¨æˆ·åˆ—è¡¨ï¼Œåº”ç”¨æŒ‡å®šçš„è½¬æ¢"
  [users transform-fn]
  (->> users
       (filter active?)
       (map transform-fn)
       (remove nil?)))

;; âŒ é¿å…åµŒå¥—è¿‡æ·±
(defn bad-process-users [users]
  (let [active (filter active? users)]
    (let [transformed (map transform active)]
      (let [filtered (remove nil? transformed)]
        filtered))))
```

#### æ–‡æ¡£å­—ç¬¦ä¸²

```clojure
;; âœ… å¥½çš„æ–‡æ¡£
(defn execute-query
  "æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœã€‚
  
  å‚æ•°:
  - `query`: MBQL æŸ¥è¯¢å¯¹è±¡
  - `options`: å¯é€‰é…ç½® mapï¼Œæ”¯æŒçš„é”®:
    - `:max-rows` - æœ€å¤§è¿”å›è¡Œæ•°
    - `:timeout` - æŸ¥è¯¢è¶…æ—¶æ—¶é—´(æ¯«ç§’)
  
  è¿”å›:
  åŒ…å«æŸ¥è¯¢ç»“æœçš„ mapï¼ŒåŒ…å« `:data` å’Œ `:metadata` é”®ã€‚
  
  å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼ŒæŠ›å‡º `ExceptionInfo`ã€‚
  
  ç¤ºä¾‹:
  ```clojure
  (execute-query {:database 1 :type :query}
                 {:max-rows 1000 :timeout 30000})
  ```
  
  å¦è§: [[compile-query]], [[metabase.query-processor/process-query]]"
  [query options]
  ...)
```

#### é”™è¯¯å¤„ç†

```clojure
;; âœ… ä½¿ç”¨ ex-info æä¾›ä¸Šä¸‹æ–‡
(defn connect-to-database [db-spec]
  (try
    (establish-connection db-spec)
    (catch Exception e
      (throw (ex-info "æ— æ³•è¿æ¥åˆ°æ•°æ®åº“"
                      {:database-id (:id db-spec)
                       :host        (:host db-spec)
                       :original-exception e}
                      e)))))
```

### TypeScript/React è§„èŒƒ

#### ç»„ä»¶è®¾è®¡

```typescript
// âœ… å¥½çš„ç»„ä»¶è®¾è®¡
interface UserCardProps {
  user: User;
  onEdit?: (user: User) => void;
  variant?: "compact" | "full";
}

export function UserCard({ 
  user, 
  onEdit, 
  variant = "compact" 
}: UserCardProps) {
  const handleEdit = useCallback(() => {
    onEdit?.(user);
  }, [user, onEdit]);
  
  return (
    <Card>
      <UserAvatar user={user} />
      <UserInfo user={user} variant={variant} />
      {onEdit && <EditButton onClick={handleEdit} />}
    </Card>
  );
}

// âŒ é¿å…
function BadUserCard(props: any) {  // ä¸ä½¿ç”¨ any
  return <div>{props.user.name}</div>;  // ç›´æ¥è®¿é—®æ·±å±‚å±æ€§
}
```

#### è‡ªå®šä¹‰ Hooks

```typescript
// âœ… å¥½çš„ Hook è®¾è®¡
function useQuestion(questionId: number) {
  const [question, setQuestion] = useState<Question | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  
  useEffect(() => {
    let cancelled = false;
    
    setLoading(true);
    fetchQuestion(questionId)
      .then(q => {
        if (!cancelled) {
          setQuestion(q);
          setError(null);
        }
      })
      .catch(err => {
        if (!cancelled) {
          setError(err);
        }
      })
      .finally(() => {
        if (!cancelled) {
          setLoading(false);
        }
      });
    
    return () => {
      cancelled = true;
    };
  }, [questionId]);
  
  return { question, loading, error };
}
```

#### Redux ä½¿ç”¨

```typescript
// âœ… ä½¿ç”¨ Redux Toolkit
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";

export const fetchDashboard = createAsyncThunk(
  "dashboard/fetch",
  async (dashboardId: number) => {
    const response = await DashboardApi.get({ id: dashboardId });
    return response;
  }
);

const dashboardSlice = createSlice({
  name: "dashboard",
  initialState: {
    current: null,
    loading: false,
    error: null,
  },
  reducers: {
    clearDashboard: (state) => {
      state.current = null;
    },
  },
  extraReducers: (builder) => {
    builder
      .addCase(fetchDashboard.pending, (state) => {
        state.loading = true;
      })
      .addCase(fetchDashboard.fulfilled, (state, action) => {
        state.current = action.payload;
        state.loading = false;
      })
      .addCase(fetchDashboard.rejected, (state, action) => {
        state.error = action.error.message;
        state.loading = false;
      });
  },
});
```

### æ€§èƒ½ä¼˜åŒ–

#### åç«¯æ€§èƒ½

```clojure
;; âœ… ä½¿ç”¨ select-one-fn é¿å…è·å–ä¸éœ€è¦çš„æ•°æ®
(t2/select-one-fn :name :model/User :id user-id)

;; âŒ é¿å…
(:name (t2/select-one :model/User :id user-id))

;; âœ… æ‰¹é‡æ“ä½œ
(t2/insert! :model/User users)

;; âŒ é¿å…å¾ªç¯æ’å…¥
(doseq [user users]
  (t2/insert! :model/User user))

;; âœ… ä½¿ç”¨æ‰¹é‡æ°´åˆ
(t2/hydrate dashboards :cards)

;; âŒ é¿å… N+1 æŸ¥è¯¢
(map #(t2/select-one :model/Card :dashboard_id (:id %)) dashboards)
```

#### å‰ç«¯æ€§èƒ½

```typescript
// âœ… ä½¿ç”¨ React.memo é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
export const ExpensiveComponent = React.memo(function ExpensiveComponent({ 
  data 
}: Props) {
  // æ˜‚è´µçš„æ¸²æŸ“é€»è¾‘
  return <div>{processData(data)}</div>;
});

// âœ… ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—
function DataView({ items }: Props) {
  const sortedItems = useMemo(
    () => items.sort((a, b) => a.name.localeCompare(b.name)),
    [items]
  );
  
  return <List items={sortedItems} />;
}

// âœ… ä½¿ç”¨ useCallback ç¨³å®šå‡½æ•°å¼•ç”¨
function Parent() {
  const handleClick = useCallback((id: number) => {
    console.log("Clicked", id);
  }, []);
  
  return <Child onClick={handleClick} />;
}

// âœ… è™šæ‹ŸåŒ–é•¿åˆ—è¡¨
import { VirtualizedList } from "metabase/components/VirtualizedList";

function LargeList({ items }: Props) {
  return (
    <VirtualizedList
      items={items}
      renderItem={(item) => <ItemRow item={item} />}
    />
  );
}
```

### æµ‹è¯•æœ€ä½³å®è·µ

#### åç«¯æµ‹è¯•

```clojure
;; âœ… å¥½çš„æµ‹è¯•ç»“æ„ (AAA æ¨¡å¼)
(deftest calculate-revenue-test
  (testing "åº”è¯¥æ­£ç¡®è®¡ç®—æ€»æ”¶å…¥"
    ;; Arrange (å‡†å¤‡)
    (let [orders [{:amount 100 :status "completed"}
                  {:amount 200 :status "completed"}
                  {:amount 50  :status "pending"}]]
      ;; Act (æ‰§è¡Œ)
      (let [result (calculate-revenue orders)]
        ;; Assert (æ–­è¨€)
        (is (= 300 result))))))

;; âœ… ä½¿ç”¨æµ‹è¯•å·¥å…·å‡½æ•°
(deftest api-endpoint-test
  (mt/with-temp [:model/Dashboard dashboard {:name "Test"}]
    (testing "GET /api/dashboard/:id"
      (is (= 200
             (:status (mt/user-http-request :crowberto :get 200
                                            (str "dashboard/" (:id dashboard)))))))))

;; âœ… å¹¶è¡Œæµ‹è¯•
(deftest ^:parallel pure-function-test
  (testing "çº¯å‡½æ•°åº”è¯¥å¹¶è¡Œè¿è¡Œ"
    (is (= 42 (my-pure-function 21)))))
```

#### å‰ç«¯æµ‹è¯•

```typescript
// âœ… å¥½çš„æµ‹è¯•ç»“æ„
describe("Dashboard", () => {
  it("åº”è¯¥æ˜¾ç¤ºåŠ è½½çŠ¶æ€", () => {
    // Arrange
    render(<Dashboard dashboardId={1} />);
    
    // Assert
    expect(screen.getByTestId("loading-spinner")).toBeInTheDocument();
  });
  
  it("åº”è¯¥åœ¨åŠ è½½åæ˜¾ç¤ºä»ªè¡¨æ¿", async () => {
    // Arrange
    const mockDashboard = createMockDashboard();
    server.use(
      rest.get("/api/dashboard/1", (req, res, ctx) => {
        return res(ctx.json(mockDashboard));
      })
    );
    
    // Act
    render(<Dashboard dashboardId={1} />);
    
    // Assert
    await waitFor(() => {
      expect(screen.getByText(mockDashboard.name)).toBeInTheDocument();
    });
  });
});

// âœ… ä½¿ç”¨ç”¨æˆ·äº¤äº’æµ‹è¯•
it("åº”è¯¥åœ¨ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ—¶æ‰“å¼€ç¼–è¾‘æ¨¡å¼", async () => {
  render(<Dashboard dashboardId={1} />);
  
  const editButton = screen.getByRole("button", { name: /ç¼–è¾‘/i });
  await userEvent.click(editButton);
  
  expect(screen.getByRole("textbox", { name: /æ ‡é¢˜/i })).toBeInTheDocument();
});
```

### å®‰å…¨æœ€ä½³å®è·µ

```clojure
;; âœ… éªŒè¯æ‰€æœ‰è¾“å…¥
(api/defendpoint POST "/"
  [name email]
  {name  [:string {:min 1 :max 100}]
   email ms/Email}
  ...)

;; âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
(t2/select :model/User :email email)

;; âŒ é¿å…å­—ç¬¦ä¸²æ‹¼æ¥ SQL
(jdbc/query (str "SELECT * FROM users WHERE email = '" email "'"))

;; âœ… æ£€æŸ¥æƒé™
(api/check-403 (mi/can-write? Card card))

;; âœ… ä¸åœ¨å®¢æˆ·ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
// âŒ é¿å…
localStorage.setItem("apiKey", apiKey);

// âœ… ä½¿ç”¨ HTTP-only cookies
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### åç«¯è°ƒè¯•

```clojure
;; ä½¿ç”¨ spy å®æŸ¥çœ‹ä¸­é—´å€¼
(require '[hashp.core])

(defn process-data [data]
  (->> data
       #p  ; æ‰“å°å¹¶è¿”å›å€¼
       (filter active?)
       #p
       (map transform)))

;; ä½¿ç”¨ tap> å‘é€åˆ° Portal
(require '[portal.api :as p])

(p/open)
(add-tap #'p/submit)

(tap> {:data data :result result})

;; ä½¿ç”¨ tools.trace è¿½è¸ªå‡½æ•°è°ƒç”¨
(require '[clojure.tools.trace :refer [trace-vars]])

(trace-vars metabase.query-processor.core/process-query)
```

### å‰ç«¯è°ƒè¯•

```typescript
// ä½¿ç”¨ React DevTools
// å®‰è£…æµè§ˆå™¨æ‰©å±•åå¯ä»¥æ£€æŸ¥ç»„ä»¶æ ‘å’Œ props

// ä½¿ç”¨ Redux DevTools
// æŸ¥çœ‹ actions å’Œ state å˜åŒ–

// æ¡ä»¶æ–­ç‚¹
function processData(data) {
  if (data.length > 1000) {
    debugger;  // åªåœ¨æ•°æ®é‡å¤§æ—¶åœæ­¢
  }
  return data.map(transform);
}

// ä½¿ç”¨ console.table æ˜¾ç¤ºæ•°ç»„
console.table(users);

// æ€§èƒ½åˆ†æ
console.time("expensive-operation");
const result = expensiveOperation();
console.timeEnd("expensive-operation");
```

---

ç»§ç»­é˜…è¯»:
- [ç¬¬ä¸€éƒ¨åˆ†: é¡¹ç›®æ¦‚è§ˆä¸æŠ€æœ¯æ ˆ](./01-é¡¹ç›®æ¦‚è§ˆä¸æŠ€æœ¯æ ˆ.md)
- [ç¬¬äºŒéƒ¨åˆ†: é¡¹ç›®æ¶æ„ä¸æ ¸å¿ƒæ¨¡å—](./02-é¡¹ç›®æ¶æ„ä¸æ ¸å¿ƒæ¨¡å—.md)
- [ç¬¬å››éƒ¨åˆ†: æµ‹è¯•ä½“ç³»ä¸éƒ¨ç½²](./04-æµ‹è¯•ä½“ç³»ä¸éƒ¨ç½².md)
