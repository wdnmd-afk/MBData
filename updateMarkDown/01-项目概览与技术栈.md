# Metabase 项目深度分析 - 第一部分: 项目概览与技术栈

> 生成时间: 2025-11-19  
> 项目路径: e:\github\metabase

---

## 📋 项目概览

### 基本信息

- **项目名称**: Metabase
- **项目描述**: 开源商业智能和数据分析平台
- **官方网站**: https://www.metabase.com
- **GitHub**: https://github.com/metabase/metabase
- **版本**: 开发版本
- **许可证**: 
  - AGPL (开源版)
  - 商业许可证 (企业版)
  - MCL (Metabase Commercial License)
  - Embedding License

### 项目定位

Metabase 是一个易用的开源数据分析平台，让公司内的每个人都能轻松查询数据并从中学习，无需 SQL 知识。

### 核心特性

1. **快速设置**: 5分钟内完成配置
2. **可视化查询**: 无需 SQL 即可提问
3. **SQL 编辑器**: 支持复杂查询
4. **交互式仪表板**: 过滤器、自动刷新、全屏显示、自定义点击行为
5. **数据模型**: 创建清理、注释或组合原始表的模型
6. **指标和分段**: 定义规范的业务指标和用户分段
7. **仪表板订阅**: 定期发送数据到 Slack 或邮箱
8. **智能告警**: 数据变化时自动通知
9. **嵌入功能**: 在应用中嵌入图表和仪表板，支持完整的 Metabase 嵌入
10. **嵌入式分析 SDK**: React 组件 SDK，支持自定义样式匹配应用设计

---

## 🛠 技术栈分析

### 后端技术栈

#### 核心语言与框架
- **Clojure**: 1.12.3 (主要后端语言)
- **Java**: >= 22 (运行时环境)
- **Ring**: 1.15.3 (HTTP 抽象层)
- **Compojure**: 1.7.2 (路由框架)
- **Jetty**: 12.1.3 (Web 服务器)

#### 数据库相关
- **next.jdbc**: 1.3.1070 (JDBC 封装)
- **HoneySQL**: 2.7.1350 (SQL 生成器)
- **Toucan2**: 1.0.569 (ORM 框架)
- **Liquibase**: 4.33.0 (数据库迁移)
- **C3P0/HikariCP**: 数据库连接池

#### 数据库驱动
- **H2**: 2.1.214 (嵌入式数据库)
- **PostgreSQL**: 42.7.7
- **MySQL/MariaDB**: 2.7.10
- 更多驱动通过 modules/drivers 提供

#### 数据处理与分析
- **Apache Commons**: Compress, Lang3, IO (工具库)
- **Apache POI**: 5.4.1 (Excel 处理)
- **Apache Tika**: 3.2.2 (文件类型检测)
- **BigML Histogram**: 5.0.0 (直方图数据结构)
- **Kixi Stats**: 0.5.7 (统计函数)
- **Simple Statistics**: 统计计算

#### 安全与认证
- **Buddy Core**: 1.12.0 (加密函数)
- **Buddy Sign**: 3.6.1 (JWT, 消息签名)
- **BCrypt**: 密码哈希
- **Bouncy Castle**: 1.82 (加密库)
- **SAML**: 4.2.1 (企业 SSO)

#### JSON 与序列化
- **Cheshire**: 6.0.0 (JSON 编码)
- **Nippy**: 3.6.0 (快速序列化)

#### 监控与分析
- **Prometheus**: 0.16.0 (指标监控)
- **Snowplow**: 1.0.1 (分析追踪)
- **Iapetos**: 0.1.14 (Prometheus 封装)
- **JVM Alloc Rate Meter**: 堆分配监控
- **JVM Hiccup Meter**: GC 暂停监控

#### AI 集成
- **OpenAI Clojure**: 0.23.0
- **JTokkit**: 1.1.0 (OpenAI tokenizer)

#### 其他重要库
- **Malli**: 0.20.0 (数据验证框架)
- **Methodical**: 1.0.127 (增强多重方法)
- **core.async**: 1.7.701 (异步编程)
- **Quartzite**: 2.2.0 (任务调度)
- **Postal**: 2.0.5 (SMTP 邮件)
- **Macaw**: 0.2.29 (SQL 解析)
- **Instaparse**: 1.5.0 (解析器生成器)
- **Flexmark**: 0.64.8 (Markdown 解析)
- **GraalVM**: 25.0.1 (JavaScript 引擎)

### 前端技术栈

#### 核心框架
- **React**: 18.2.0
- **React-DOM**: 18.2.0
- **TypeScript**: 5.9.2
- **Redux Toolkit**: 2.5.0
- **React-Redux**: 9.1.2

#### UI 组件库
- **Mantine**: 8.3.5 (主要 UI 框架)
  - @mantine/core
  - @mantine/dates
  - @mantine/hooks
- **Emotion**: 11.11.0 (CSS-in-JS)
  - @emotion/react
  - @emotion/styled
- **TipTap**: 3.2.0 (富文本编辑器)
  - 多个扩展: bubble-menu, image, mention, placeholder

#### 数据可视化
- **D3**: 7.9.0 (核心可视化库)
- **Visx**: 图表组件库
  - @visx/axis, @visx/grid, @visx/scale, @visx/shape
- **ECharts**: 6.0.0 (图表库)
- **Leaflet**: 1.2.0 (地图可视化)
  - leaflet-draw, leaflet.heat
- **React Grid Layout**: 1.4.4 (可拖拽布局)

#### 表格与数据处理
- **@tanstack/react-table**: 8.21.2 (强大的表格组件)
- **@tanstack/react-virtual**: 3.13.2 (虚拟滚动)
- **React-Virtualized**: 9.22.6
- **Crossfilter**: 1.3.12 (多维数据过滤)
- **CSV Parse/Stringify**: CSV 处理

#### 代码编辑与格式化
- **CodeMirror**: @uiw/react-codemirror 4.23.6
  - 支持 SQL, JavaScript, Python, JSON, HTML
- **SQL Formatter**: 15.1.2 (SQL 格式化)

#### 拖拽与交互
- **DnD Kit**: 6.0.8 (拖放功能)
  - @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/modifiers
- **React-DnD**: 4.x (旧版拖放)
- **React-Dropzone**: 14.2.3 (文件上传)

#### 表单与验证
- **Formik**: 2.4.5 (表单管理)
- **Yup**: 0.32.11 (验证库)

#### 路由
- **React Router**: 3.x (旧版本)
- **React Router Redux**: 4.0.8
- **History**: 3.x

#### 工具库
- **Lodash**: 部分函数 (debounce, orderby)
- **Underscore**: 1.13.3
- **Immer**: 10.1.1 (不可变数据)
- **Day.js**: 1.11.18 (日期处理)
- **Moment-Timezone**: 0.5.38 (时区处理)
- **Inflection**: 1.7.1 (单复数转换)
- **Color**: 4.2.3 (颜色处理)
- **Bowser**: 2.11.0 (浏览器检测)

#### 构建工具
- **Rspack**: 1.5.8 (主要构建工具，webpack 替代品)
- **Babel**: 7.23.3 (JavaScript 编译器)
- **SWC**: 1.13.5 (快速编译器)
- **PostCSS**: 8.5.6 (CSS 处理)
  - postcss-nested, postcss-preset-env, postcss-import

#### 开发工具
- **ESLint**: 7.32.0 (代码检查)
- **Prettier**: 3.3.3 (代码格式化)
- **Stylelint**: 16.25.0 (CSS 检查)
- **TypeScript**: 5.9.2 (类型检查)
- **Husky**: 8.0.2 (Git hooks)
- **Lint-Staged**: 13.1.2 (暂存文件检查)

#### 测试框架
- **Jest**: 29.7.0 (单元测试)
- **Testing Library**: React 16.0.0 (React 测试)
- **Cypress**: 14.5.3 (E2E 测试)
  - 多个插件: grep, real-events, split, terminal-report
- **MSW**: 2.7.5 (Mock Service Worker)
- **Loki**: 0.35.1 (视觉回归测试)

#### Storybook
- **Storybook**: 8.5.0 (组件开发环境)
  - 多个插件: a11y, essentials, interactions, themes

### ClojureScript 技术栈

- **Shadow-CLJS**: 3.2.1 (ClojureScript 构建)
- **CLJS Bean**: 1.9.0 (JS 互操作)
- **Glogi**: 1.3.169 (日志)
- **Piggieback**: 0.6.1 (REPL)
- **DevTools**: 1.0.7 (浏览器开发工具)

---

## 📦 项目结构

### 顶层目录

```
metabase/
├── frontend/              # 前端代码 (React/TypeScript)
├── enterprise/            # 企业版代码
├── src/                   # 后端源码 (Clojure)
├── test/                  # 后端测试
├── modules/               # 可选模块 (驱动)
├── e2e/                   # E2E 测试
├── docs/                  # 文档
├── resources/             # 资源文件
├── bin/                   # 脚本工具
├── dev/                   # 开发辅助
├── hooks/                 # Git hooks
├── locales/               # 国际化
├── patches/               # NPM 包补丁
└── snowplow/              # 分析追踪配置
```

### 配置文件概览

- **deps.edn**: Clojure 依赖和别名 (925行)
- **package.json**: Node 依赖和脚本 (529行)
- **shadow-cljs.edn**: ClojureScript 配置
- **tsconfig.json**: TypeScript 配置
- **rspack.*.config.js**: 多个构建配置文件
- **.eslintrc.js**: ESLint 配置
- **.prettierrc**: Prettier 配置
- **.stylelintrc.json**: Stylelint 配置
- **jest.config.js**: Jest 测试配置
- **cypress.env.json.example**: Cypress 配置示例
- **CLAUDE.md**: AI 辅助开发指南 (723行)

---

## 🔧 开发环境要求

### 必需软件

1. **Node.js**: >= 22 (指定在 package.json engines)
2. **Yarn**: ^1.22.22 (包管理器)
3. **Java**: >= 22 (Clojure 运行时)
4. **Clojure CLI Tools**: 最新版

### 可选工具

- **Docker**: 用于容器化部署
- **Git**: 版本控制
- **IDE/编辑器**: 
  - IntelliJ IDEA + Cursive (Clojure 开发)
  - VS Code + Calva (Clojure 开发)
  - VS Code (TypeScript/React 开发)

---

## 🚀 快速启动

### ⚠️ Windows 用户注意

在 Windows Git Bash 中,`yarn dev` 命令存在兼容性问题,建议使用**方法 2: 分别启动**。

### 方法 1: 一键启动 (Linux/Mac)

```bash
# 同时启动前后端
yarn dev
```

这会启动:
- 前端开发服务器 (热重载)
- 后端 Clojure 服务器
- ClojureScript 编译
- 静态可视化构建

### 方法 2: 分别启动 (推荐 Windows 用户)

#### 步骤 1: 安装依赖

```bash
# 安装 Node 依赖
yarn install

# 安装 cross-env (Windows 兼容性)
yarn add -D cross-env
```

#### 步骤 2: 启动前端

**打开第一个 Git Bash 窗口**:

```bash
cd /e/github/metabase

# 启动前端开发服务器 (支持热重载)
yarn build-hot:js
```

**预期输出**:
```
✅ Rspack compiled successfully
🌐 Project is running at: http://localhost:8080/
```

#### 步骤 3: 启动后端

**打开第二个 Git Bash 窗口**:

```bash
cd /e/github/metabase

# 启动后端服务器
clojure -M:run
```

**预期输出** (需要 3-5 分钟):
```
Starting Metabase...
Metabase Initialization COMPLETE
```

#### 步骤 4: 访问应用

后端启动完成后,打开浏览器访问:

**http://localhost:3000**

> 💡 **提示**: 虽然前端在 8080 端口,但实际访问使用 **3000 端口** (后端代理前端)

### 方法 3: 企业版开发

```bash
# 启动企业版开发环境
yarn dev-ee

# 或者带后端热重载
yarn dev-hot-be
```

### 访问地址

- **主应用**: http://localhost:3000
- **前端开发服务器**: http://localhost:8080 (仅开发时)
- **Storybook**: http://localhost:6006
- **API**: http://localhost:3000/api

---

## 📝 重要说明

1. **首次启动**: 第一次运行需要较长时间下载依赖
2. **内存要求**: 建议至少 8GB RAM
3. **端口占用**: 确保 3000, 3001, 6006 等端口未被占用
4. **数据库**: 默认使用 H2 嵌入式数据库
5. **驱动构建**: 开发数据库驱动功能前必须运行 `./bin/build-drivers.sh`

---

继续阅读:
- [第二部分: 项目架构与核心模块](./02-项目架构与核心模块.md)
- [第三部分: 开发工作流与最佳实践](./03-开发工作流与最佳实践.md)
- [第四部分: 测试体系与部署](./04-测试体系与部署.md)
