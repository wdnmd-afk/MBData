# Metabase 国际化问题诊断与修复指南

## 问题描述

用户在设置中选择中文后,系统没有正确切换为中文界面。

## 根本原因分析

### 1. 翻译文件未编译

Metabase 的国际化实现流程:
```
locales/*.po (源文件) 
  ↓ 编译
resources/frontend_client/app/locales/*.json (运行时文件)
  ↓ 加载
前端应用显示翻译
```

**问题**: 开发环境中,`.po` 翻译文件需要先编译成 `.json` 文件,但这一步可能被遗漏。

### 2. 代码逻辑验证

经过代码审查,以下逻辑都是正确的:

✅ **前端locale更新逻辑** (`frontend/src/metabase/account/profile/actions.ts`):
```typescript
if (user.locale !== data.locale) {
  window.location.reload(); // 切换语言后会刷新页面
}
```

✅ **后端API支持** (`src/metabase/users_rest/api.clj` 第451行):
```clojure
[:locale {:optional true} [:maybe ms/ValidLocale]]  // 接受locale参数
```

✅ **前端加载逻辑** (`frontend/src/metabase/lib/i18n.js`):
```javascript
await fetch(`${api.basename}/app/locales/${locale}.json`)
```

## 解决方案

### 方案 1: 编译翻译文件(推荐)

#### 步骤 1: 编译翻译资源

```bash
# 在项目根目录执行
./bin/i18n/build-translation-resources
```

这个命令会:
- 读取 `locales/*.po` 文件
- 编译成 JSON 格式
- 输出到 `resources/frontend_client/app/locales/` 目录

#### 步骤 2: 验证生成的文件

```bash
# 检查是否生成了中文翻译文件
ls -la resources/frontend_client/app/locales/zh*.json
```

应该看到:
- `zh-CN.json` (简体中文)
- `zh-TW.json` (繁体中文)
- `zh-HK.json` (香港繁体)

#### 步骤 3: 重启后端

```bash
# 停止当前运行的后端(Ctrl+C)
# 重新启动
clojure -M:run
```

#### 步骤 4: 测试

1. 打开浏览器访问 http://localhost:3000
2. 登录后进入 **Settings** → **Account Settings**
3. 在 **Language** 下拉框中选择 **简体中文**
4. 点击 **Update**
5. 页面应该自动刷新并显示中文界面

---

### 方案 2: 检查现有翻译文件

如果翻译文件已经存在但仍然不工作:

#### 检查文件是否存在

```bash
# 检查翻译文件
find resources -name "*.json" | grep locale
```

#### 检查文件内容

```bash
# 查看中文翻译文件的前几行
head -20 resources/frontend_client/app/locales/zh-CN.json
```

应该看到类似这样的JSON结构:
```json
{
  "headers": {
    "language": "zh-CN",
    "plural-forms": "nplurals=1; plural=0;"
  },
  "translations": {
    "": {
      "Dashboard": {
        "msgid": "Dashboard",
        "msgstr": ["仪表板"]
      }
    }
  }
}
```

#### 检查浏览器网络请求

1. 打开浏览器开发者工具 (F12)
2. 切换到 **Network** 标签
3. 在设置中选择中文
4. 查看是否有请求 `/app/locales/zh-CN.json`
5. 检查响应状态:
   - **200**: 文件加载成功,检查内容是否正确
   - **404**: 文件不存在,需要编译翻译文件
   - **500**: 服务器错误,检查后端日志

---

### 方案 3: 完整的开发环境设置

如果上述方案都不工作,执行完整的构建流程:

```bash
# 1. 清理旧的构建文件
rm -rf resources/frontend_client/app/locales/*.json

# 2. 编译翻译文件
./bin/i18n/build-translation-resources

# 3. 重新构建前端(如果需要)
yarn build-hot

# 4. 重启后端
clojure -M:run
```

---

## 常见问题排查

### Q1: 编译翻译文件时报错

**错误**: `bash: ./bin/i18n/build-translation-resources: Permission denied`

**解决**:
```bash
chmod +x ./bin/i18n/build-translation-resources
./bin/i18n/build-translation-resources
```

### Q2: 翻译文件编译成功但界面仍是英文

**可能原因**:
1. 浏览器缓存问题
2. 用户设置未正确保存

**解决步骤**:
```bash
# 1. 清除浏览器缓存
# 在浏览器中按 Ctrl+Shift+Delete,清除缓存

# 2. 检查数据库中的用户locale设置
# 如果使用H2数据库,检查 metabase.db.mv.db
# 用户的locale应该存储在 core_user 表中
```

### Q3: 部分文本显示中文,部分仍是英文

**原因**: 某些字符串可能未翻译

**解决**:
1. 这是正常的,不是所有字符串都有翻译
2. 可以贡献翻译到 Metabase 社区
3. 或者在 `locales/zh-CN.po` 中添加缺失的翻译

---

## 技术细节

### 国际化架构

```
┌─────────────────────────────────────────────────┐
│  用户在设置中选择语言                              │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  前端发送 PUT /api/user/:id                      │
│  body: { locale: "zh-CN" }                      │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  后端更新数据库 core_user 表                      │
│  SET locale = 'zh-CN' WHERE id = ?              │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  前端检测到 locale 变化                           │
│  window.location.reload()                       │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  页面重新加载,读取用户的 locale 设置              │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  前端加载翻译文件                                 │
│  GET /app/locales/zh-CN.json                    │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  ttag 库应用翻译                                  │
│  所有 t`text` 调用都会被翻译                      │
└─────────────────────────────────────────────────┘
```

### 关键文件位置

**翻译源文件**:
- `locales/zh-CN.po` - 简体中文翻译
- `locales/zh-TW.po` - 繁体中文翻译
- `locales/zh-HK.po` - 香港繁体翻译

**编译后的文件**:
- `resources/frontend_client/app/locales/zh-CN.json`
- `resources/frontend_client/app/locales/zh-TW.json`
- `resources/frontend_client/app/locales/zh-HK.json`

**前端代码**:
- `frontend/src/metabase/lib/i18n.js` - 国际化核心逻辑
- `frontend/src/metabase/account/profile/actions.ts` - 用户设置更新
- `frontend/src/metabase/public/LocaleProvider.tsx` - Locale Provider

**后端代码**:
- `src/metabase/users_rest/api.clj` - 用户API
- `src/metabase/system/settings.clj` - 系统设置(site-locale)
- `src/metabase/util/i18n/` - 后端国际化工具

---

## 快速修复命令

如果你只是想快速修复问题,执行以下命令:

```bash
# 1. 编译翻译文件
./bin/i18n/build-translation-resources

# 2. 等待编译完成(大约10-30秒)

# 3. 重启后端(如果正在运行)
# 在运行 clojure -M:run 的终端按 Ctrl+C
# 然后重新运行:
clojure -M:run

# 4. 清除浏览器缓存并刷新页面
# 或者使用无痕模式测试
```

---

## 验证清单

在修复后,使用以下清单验证问题是否解决:

- [ ] 翻译文件已编译: `ls resources/frontend_client/app/locales/zh-CN.json`
- [ ] 后端已重启并正常运行
- [ ] 浏览器缓存已清除
- [ ] 在用户设置中选择"简体中文"
- [ ] 点击"Update"后页面自动刷新
- [ ] 界面显示中文(至少主要菜单和按钮)
- [ ] 浏览器控制台无错误
- [ ] Network标签显示成功加载 `zh-CN.json` (状态200)

---

## 贡献翻译

如果你发现某些文本没有翻译,可以:

1. 编辑 `locales/zh-CN.po` 文件
2. 找到对应的 `msgid` (英文原文)
3. 填写 `msgstr` (中文翻译)
4. 重新编译翻译文件
5. 提交 Pull Request 到 Metabase 仓库

示例:
```po
msgid "Dashboard"
msgstr "仪表板"

msgid "Question"
msgstr "问题"
```

---

## 总结

国际化问题的核心是**翻译文件需要先编译**。在开发环境中,这一步不会自动执行,需要手动运行编译脚本。

**记住这个命令**:
```bash
./bin/i18n/build-translation-resources
```

每次更新翻译文件或切换分支后,都应该运行这个命令。
